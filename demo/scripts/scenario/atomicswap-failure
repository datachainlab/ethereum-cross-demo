#!/usr/bin/env bash

# ==============================================================================
# SCENARIO: ERC20 Cross-Chain Atomic Swap (Failure Case: Missing Approval)
# ==============================================================================
#
# [ACTORS]
#   - Alice (Coordinator Chain): Initiator.
#   - Bob   (Participant Chain): Counterparty.
#
# [PROCESS (FAILURE DEMO)]
#   1. Setup: Mint tokens on both chains (10 each).
#   2. Auth : Alice approves the bridge. **Bob intentionally skips the Approve step.**
#   3. Sign : Alice initiates the trade; Bob signs the agreement on the Coordinator.
#   4. Exec : Relayer attempts to execute the swap.
#   5. Fail : The transaction on the Participant chain REVERTS because the
#             Bridge Contract does not have allowance to spend Bob's tokens.
#
# [RESULT (Rollback / No Change)]
#   Alice: [Coord: 10, Part: 0] (Unchanged)
#   Bob  : [Coord: 0,  Part: 10] (Unchanged)
#   * The swap fails atomically. The protocol ensures funds remain with owners.
# ==============================================================================

set -eu

# --- Environment & Imports ---
CUR_DIR=$(cd $(dirname ${BASH_SOURCE:-$0}); pwd)
source "${CUR_DIR}/../util/env"
source "${CUR_DIR}/../util/util"

debugMode ${1+x}

# --- Configuration ---
MINT_AMT=10
TX_AMT=10
DATA_DIR="${CUR_DIR}/../../data"
mkdir -p "${DATA_DIR}"

# Output files
FILE_TX_BOB="${DATA_DIR}/erc20-tx-bob-to-alice.json"
FILE_TX_ALICE="${DATA_DIR}/erc20-tx-alice-to-bob.json"
FILE_INIT_TX="${DATA_DIR}/b2b-tx-1.json"

infoln "### Resetting Balances (Cleanup) ###"

# --- 1. Reset Coordinator: Alice ---
BAL_COORD_ALICE=$(${ERC20CLI_COORDINATOR_ALICE} erc20 balanceOf --address ${ALICE_ADDRESS} | tail -n 1 | tr -d '\r\n')
if [[ "$BAL_COORD_ALICE" =~ ^[0-9]+$ ]] && [ "$BAL_COORD_ALICE" -gt 0 ]; then
    infoln "Resetting Alice (Coordinator) balance: ${BAL_COORD_ALICE} -> 0"
    printERC20 "${ERC20CLI_COORDINATOR_ALICE} erc20 transfer --address ${BRIDGE_CONTRACT_ADDR} --amount ${BAL_COORD_ALICE}"
fi

# --- 2. Reset Coordinator: Bob ---
BAL_COORD_BOB=$(${ERC20CLI_COORDINATOR_BOB} erc20 balanceOf --address ${BOB_ADDRESS} | tail -n 1 | tr -d '\r\n')
if [[ "$BAL_COORD_BOB" =~ ^[0-9]+$ ]] && [ "$BAL_COORD_BOB" -gt 0 ]; then
    infoln "Resetting Bob (Coordinator) balance: ${BAL_COORD_BOB} -> 0"
    printERC20 "${ERC20CLI_COORDINATOR_BOB} erc20 transfer --address ${BRIDGE_CONTRACT_ADDR} --amount ${BAL_COORD_BOB}"
fi

# --- 3. Reset Participant: Alice ---
BAL_PART_ALICE=$(${ERC20CLI_PARTICIPANT_ALICE} erc20 balanceOf --address ${ALICE_ADDRESS} | tail -n 1 | tr -d '\r\n')
if [[ "$BAL_PART_ALICE" =~ ^[0-9]+$ ]] && [ "$BAL_PART_ALICE" -gt 0 ]; then
    infoln "Resetting Alice (Participant) balance: ${BAL_PART_ALICE} -> 0"
    printERC20 "${ERC20CLI_PARTICIPANT_ALICE} erc20 transfer --address ${BRIDGE_CONTRACT_ADDR} --amount ${BAL_PART_ALICE}"
fi

# --- 4. Reset Participant: Bob ---
BAL_PART_BOB=$(${ERC20CLI_PARTICIPANT_BOB} erc20 balanceOf --address ${BOB_ADDRESS} | tail -n 1 | tr -d '\r\n')
if [[ "$BAL_PART_BOB" =~ ^[0-9]+$ ]] && [ "$BAL_PART_BOB" -gt 0 ]; then
    infoln "Resetting Bob (Participant) balance: ${BAL_PART_BOB} -> 0"
    printERC20 "${ERC20CLI_PARTICIPANT_BOB} erc20 transfer --address ${BRIDGE_CONTRACT_ADDR} --amount ${BAL_PART_BOB}"
fi

infoln "All balances reset complete."

infoln "### ERC20 Fixture Setup ###"

# --- 1. Setup Coordinator Chain (31337) ---
infoln "Minting on Coordinator..."
printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} erc20 mint --address ${ALICE_ADDRESS} --amount ${MINT_AMT}"
sleep 2

# --- 2. Setup Participant Chain (31338) ---
infoln "Minting on Participant..."
printERC20 "${ERC20CLI_PARTICIPANT_PLATFORMER} erc20 mint --address ${BOB_ADDRESS} --amount ${MINT_AMT}"
sleep 2

infoln "Fixture setup completed."

# --- 3. Prepare Contract Tx: Bob -> Alice (Participant) ---
infoln "Creating Tx: Bob -> Alice (Participant)"
CHAN_PART="channel-0:cross"

# Generate ABI encoded call info (Bob -> Alice, 10 tokens)
CALL_INFO_BOB=$(cast abi-encode "f(address,address,uint256)" "${BOB_ADDRESS}" "${ALICE_ADDRESS}" "${TX_AMT}")
CALL_INFO_BOB=${CALL_INFO_BOB#0x}

printERC20 "${ERC20CLI_PARTICIPANT_PLATFORMER} cross create-contract-tx \
    --initiator-chain-channel ${CHAN_PART} \
    --signer ${BOB_ADDRESS} \
    --call-info ${CALL_INFO_BOB} \
    --output-document ${FILE_TX_BOB}"

# printERC20 "${ERC20CLI_PARTICIPANT_BOB} erc20 approve --address ${BRIDGE_ADDR} --amount ${TX_AMT}" ## <- APPROVAL OMITTED FOR FAILURE SCENARIO

# --- 4. Prepare Contract Tx: Alice -> Bob (Coordinator) ---
infoln "Creating Tx: Alice -> Bob (Coordinator)"
CHAN_COORD=":"

# Generate ABI encoded call info (Alice -> Bob, 10 tokens)
CALL_INFO_ALICE=$(cast abi-encode "f(address,address,uint256)" "${ALICE_ADDRESS}" "${BOB_ADDRESS}" "${TX_AMT}")
CALL_INFO_ALICE=${CALL_INFO_ALICE#0x}

printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross create-contract-tx \
    --initiator-chain-channel ${CHAN_COORD} \
    --signer ${ALICE_ADDRESS} \
    --call-info ${CALL_INFO_ALICE} \
    --output-document ${FILE_TX_ALICE}"

printERC20 "${ERC20CLI_COORDINATOR_ALICE} erc20 approve --address ${BRIDGE_CONTRACT_ADDR} --amount ${TX_AMT}"

# --- 5. Initiate Cross-Chain Transaction ---
infoln "Creating and Sending InitiateTx..."

# Create composite transaction file
printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross create-initiate-tx \
    --contract-txs=${FILE_TX_ALICE},${FILE_TX_BOB} \
    --output-document=${FILE_INIT_TX}"

# Send transaction and capture output
CMD="${ERC20CLI_COORDINATOR_PLATFORMER} cross send-initiate-tx \
    --initiate-tx=${FILE_INIT_TX} \
    --eth-sign-key=${ALICE_PRIVATE_KEY}"

infoln "Executing: $CMD"
OUTPUT=$(eval $CMD) || { echo "Error: Transaction failed."; exit 1; }

# Extract TxID
TX_ID=$(echo "$OUTPUT" | grep "TxID (Hex):" | awk '{print $3}')
if [ -z "$TX_ID" ]; then
    echo "Error: Failed to extract TX_ID. Raw output: $OUTPUT"
    exit 1
fi
infoln "TxID extracted: ${TX_ID}"

# --- 6. Authorization & Signing ---
printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross tx-auth-state $TX_ID"

infoln "Bob signs the transaction..."
printERC20 "${ERC20CLI_COORDINATOR_BOB} cross ext-sign-tx ${TX_ID} --eth-sign-key=${BOB_PRIVATE_KEY}"
sleep 3

printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross tx-auth-state $TX_ID"
printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross coordinator-state $TX_ID"

# --- 7. Relayer Operations ---
infoln "Relaying packets..."
set +e
sleep 3
${RLY} query unrelayed-packets ${PATH_NAME}
${RLY} tx relay ${PATH_NAME}

sleep 3
${RLY} query unrelayed-acknowledgements ${PATH_NAME}
${RLY} tx relay-acknowledgements ${PATH_NAME}
set -e
sleep 3

printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross coordinator-state $TX_ID"

# --- 8. Final Verification ---
infoln "### Final Balance Verification (Expect No Change) ###"

# Coordinator Balances
# Alice: 10 -> 10 (Rollback / Unchanged)
assertBalance "Coordinator" "Alice" "${ERC20CLI_COORDINATOR_ALICE} erc20 balanceOf --address ${ALICE_ADDRESS}" "${MINT_AMT}"
# Bob: 0 -> 0 (Rollback / Unchanged)
assertBalance "Coordinator" "Bob" "${ERC20CLI_COORDINATOR_BOB} erc20 balanceOf --address ${BOB_ADDRESS}" "0"

# Participant Balances
# Alice: 0 -> 0 (Rollback / Unchanged)
assertBalance "Participant" "Alice" "${ERC20CLI_PARTICIPANT_ALICE} erc20 balanceOf --address ${ALICE_ADDRESS}" "0"
# Bob: 10 -> 10 (Rollback / Unchanged)
assertBalance "Participant" "Bob" "${ERC20CLI_PARTICIPANT_BOB} erc20 balanceOf --address ${BOB_ADDRESS}" "${MINT_AMT}"

infoln "âœ… SUCCESS: Transaction failed atomically as expected. Balances remain unchanged."
