#!/usr/bin/env bash

set -eu

# --- Environment & Imports ---
CUR_DIR=$(cd $(dirname ${BASH_SOURCE:-$0}); pwd)
source "${CUR_DIR}/../util/env"
source "${CUR_DIR}/../util/util"
source "${CUR_DIR}/util/color"

debugMode ${1+x}

# --- Configuration ---
MINT_AMT=10
TX_AMT=10
DATA_DIR="${CUR_DIR}/../../data"
mkdir -p "${DATA_DIR}"

# Address of the Bridge/Lock contract (for approval)
BRIDGE_ADDR="0x2F5703804E29F4252FA9405B8D357220d11b3bd9"

# Output files
FILE_TX_BOB="${DATA_DIR}/erc20-tx-bob-to-alice.json"
FILE_TX_ALICE="${DATA_DIR}/erc20-tx-alice-to-bob.json"
FILE_INIT_TX="${DATA_DIR}/b2b-tx-1.json"

infoln "### ERC20 Fixture Setup ###"

# --- 1. Setup Coordinator Chain (31337) ---
infoln "Minting on Coordinator..."
printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} erc20 mint --address ${ALICE_ADDRESS} --amount ${MINT_AMT}"
sleep 2

# --- 2. Setup Participant Chain (31338) ---
infoln "Minting on Participant..."
printERC20 "${ERC20CLI_PARTICIPANT_PLATFORMER} erc20 mint --address ${BOB_ADDRESS} --amount ${MINT_AMT}"
sleep 2

infoln "Fixture setup completed."

# --- 3. Prepare Contract Tx: Bob -> Alice (Participant) ---
infoln "Creating Tx: Bob -> Alice (Participant)"
CHAN_PART="channel-0:cross"

# Generate ABI encoded call info (Bob -> Alice, 10 tokens)
CALL_INFO_BOB=$(cast abi-encode "f(address,address,uint256)" "${BOB_ADDRESS}" "${ALICE_ADDRESS}" "${TX_AMT}")
CALL_INFO_BOB=${CALL_INFO_BOB#0x}

printERC20 "${ERC20CLI_PARTICIPANT_PLATFORMER} cross create-contract-tx \
    --initiator-chain-channel ${CHAN_PART} \
    --signer ${BOB_ADDRESS} \
    --call-info ${CALL_INFO_BOB} \
    --output-document ${FILE_TX_BOB}"

# printERC20 "${ERC20CLI_PARTICIPANT_BOB} erc20 approve --address ${BRIDGE_ADDR} --amount ${TX_AMT}" ## <- APPROVAL OMITTED FOR FAILURE SCENARIO

# --- 4. Prepare Contract Tx: Alice -> Bob (Coordinator) ---
infoln "Creating Tx: Alice -> Bob (Coordinator)"
CHAN_COORD=":"

# Generate ABI encoded call info (Alice -> Bob, 10 tokens)
CALL_INFO_ALICE=$(cast abi-encode "f(address,address,uint256)" "${ALICE_ADDRESS}" "${BOB_ADDRESS}" "${TX_AMT}")
CALL_INFO_ALICE=${CALL_INFO_ALICE#0x}

printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross create-contract-tx \
    --initiator-chain-channel ${CHAN_COORD} \
    --signer ${ALICE_ADDRESS} \
    --call-info ${CALL_INFO_ALICE} \
    --output-document ${FILE_TX_ALICE}"

printERC20 "${ERC20CLI_COORDINATOR_ALICE} erc20 approve --address ${BRIDGE_ADDR} --amount ${TX_AMT}"

# --- 5. Initiate Cross-Chain Transaction ---
infoln "Creating and Sending InitiateTx..."

# Create composite transaction file
printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross create-initiate-tx \
    --contract-txs=${FILE_TX_ALICE},${FILE_TX_BOB} \
    --output-document=${FILE_INIT_TX}"

# Send transaction and capture output
CMD="${ERC20CLI_COORDINATOR_PLATFORMER} cross send-initiate-tx \
    --initiate-tx=${FILE_INIT_TX} \
    --eth-sign-key=${ALICE_PRIVATE_KEY}"

infoln "Executing: $CMD"
OUTPUT=$(eval $CMD) || { echo "Error: Transaction failed."; exit 1; }

# Extract TxID
TX_ID=$(echo "$OUTPUT" | grep "TxID (Hex):" | awk '{print $3}')
if [ -z "$TX_ID" ]; then
    echo "Error: Failed to extract TX_ID. Raw output: $OUTPUT"
    exit 1
fi
infoln "TxID extracted: ${TX_ID}"

# --- 6. Authorization & Signing ---
printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross tx-auth-state $TX_ID"

infoln "Bob signs the transaction..."
printERC20 "${ERC20CLI_COORDINATOR_BOB} cross ext-sign-tx ${TX_ID} --eth-sign-key=${BOB_PRIVATE_KEY}"
sleep 3

printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross tx-auth-state $TX_ID"
printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross coordinator-state $TX_ID"

# --- 7. Relayer Operations ---
infoln "Relaying packets..."
set +e
sleep 3
${RLY} query unrelayed-packets ${PATH_NAME}
${RLY} tx relay ${PATH_NAME}

sleep 3
${RLY} query unrelayed-acknowledgements ${PATH_NAME}
${RLY} tx relay-acknowledgements ${PATH_NAME}
set -e
sleep 3

printERC20 "${ERC20CLI_COORDINATOR_PLATFORMER} cross coordinator-state $TX_ID"

# --- 8. Final Verification ---
infoln "### Final Balance Verification ###"

infoln "Coordinator Balances (Expect: Alice 10, Bob 0):"
printERC20 "${ERC20CLI_COORDINATOR_ALICE} erc20 balanceOf --address ${ALICE_ADDRESS}"
printERC20 "${ERC20CLI_COORDINATOR_BOB} erc20 balanceOf --address ${BOB_ADDRESS}"

infoln "Participant Balances (Expect: Alice 0, Bob 10):"
printERC20 "${ERC20CLI_PARTICIPANT_ALICE} erc20 balanceOf --address ${ALICE_ADDRESS}"
printERC20 "${ERC20CLI_PARTICIPANT_BOB} erc20 balanceOf --address ${BOB_ADDRESS}"
